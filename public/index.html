<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#F2F0E9" id="theme-color-meta" />
    <meta
      name="description"
      content="Powerful tool for manage Claude, ChatGPT, Gemini and SillyTavern chat conversations."
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo1024.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    
    <!-- PWA ç›¸å…³metaæ ‡ç­¾ -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Lyra Exporter">
    
    <title>Lyra's Exporter</title>
    <meta name="author" content="Yalums" />
    <meta name="copyright" content="Â© 2025 Lyra Exporter. All Rights Reserved." />
    
    <!-- åŠ¨æ€ä¸»é¢˜è‰²è®¾ç½® -->
    <script>
      // è®¾ç½®åŠ¨æ€ä¸»é¢˜è‰²
      function updateThemeColor() {
        // æ£€æŸ¥ç³»ç»Ÿä¸»é¢˜åå¥½å’Œæ‰‹åŠ¨è®¾ç½®
        const htmlElement = document.documentElement;
        const manualTheme = htmlElement.getAttribute('data-theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        // å†³å®šå½“å‰ä¸»é¢˜ï¼šæ‰‹åŠ¨è®¾ç½®ä¼˜å…ˆï¼Œå¦åˆ™è·Ÿéšç³»ç»Ÿ
        const isDark = manualTheme ? manualTheme === 'dark' : prefersDark;
        
        const themeColorMeta = document.getElementById('theme-color-meta');
        const newColor = isDark ? '#262624' : '#F2F0E9';
        
        if (themeColorMeta) {
          themeColorMeta.setAttribute('content', newColor);
        }
        
        // åŒæ—¶è®¾ç½®CSSå˜é‡ï¼Œç¡®ä¿PWAå¯åŠ¨æ—¶èƒŒæ™¯æ­£ç¡®
        document.documentElement.style.setProperty('--pwa-bg-color', newColor);
        
        console.log('ä¸»é¢˜è‰²å·²æ›´æ–°ä¸º:', newColor, 'ï¼ˆæ˜¯å¦æ·±è‰²:', isDark, 'ï¼‰');
      }
      
      // ç«‹å³æ‰§è¡Œä¸€æ¬¡
      updateThemeColor();
      
      // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateThemeColor);
      
      // ç›‘å¬æ‰‹åŠ¨ä¸»é¢˜åˆ‡æ¢ï¼ˆå¦‚æœåº”ç”¨æœ‰ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ï¼‰
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
            updateThemeColor();
          }
        });
      });
      
      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-theme']
      });
      
      // å…¨å±€æš´éœ²å‡½æ•°ï¼Œä¾›åº”ç”¨è°ƒç”¨
      window.updatePWAThemeColor = updateThemeColor;
    </script>
    
    <!-- æ·»åŠ å¯åŠ¨ç”»é¢èƒŒæ™¯è‰²CSS -->
    <style>
      html {
        background-color: var(--pwa-bg-color, #F2F0E9);
      }
      
      @media (prefers-color-scheme: dark) {
        html {
          background-color: #262624;
        }
      }
    </style>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    
    <!-- Service Worker æ³¨å†Œ -->
    <script>
// Service Worker æ³¨å†Œ - ä»…åœ¨ç”Ÿäº§ç¯å¢ƒ
if ('serviceWorker' in navigator && window.location.hostname !== 'localhost' && !window.location.hostname.startsWith('127.')) {
  window.addEventListener('load', () => {
    const swUrl = `${process.env.PUBLIC_URL || ''}/sw.js`;
    
    navigator.serviceWorker.register(swUrl)
      .then(registration => {
        console.log('SWæ³¨å†ŒæˆåŠŸ:', registration);
        
        // æ£€æŸ¥æ›´æ–°
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('å‘ç°æ–°ç‰ˆæœ¬ Service Worker');
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('æ–°ç‰ˆæœ¬å·²å‡†å¤‡å°±ç»ª');
              newWorker.postMessage({ type: 'SKIP_WAITING' });
              
              navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
              });
            }
          });
        });
        
        // å®šæœŸæ£€æŸ¥æ›´æ–°
        setInterval(() => {
          registration.update();
        }, 30000);
      })
      .catch(error => {
        console.log('SWæ³¨å†Œå¤±è´¥ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰:', error);
      });
  });
} else {
  console.log('å¼€å‘ç¯å¢ƒ - Service Worker å·²ç¦ç”¨');
}
    </script>

    <style>
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (prefers-color-scheme: dark) {
        #version-announcement > div > div {
          background: #2a2a2a !important;
        }
        #version-announcement h2 {
          color: #e0e0e0 !important;
        }
        #version-announcement p,
        #version-announcement strong {
          color: #d0d0d0 !important;
        }
        #version-announcement li span {
          color: #999 !important;
        }
      }
    </style>

    <script>
      // ç‰ˆæœ¬å…¬å‘Šç®¡ç†
      const ANNOUNCEMENT_VERSION = 'v1.3.0'; // æ›´æ–°ç‰ˆæœ¬å·ä¼šé‡æ–°æ˜¾ç¤ºå…¬å‘Š
      const STORAGE_KEY = 'announcement_seen_' + ANNOUNCEMENT_VERSION;

      // æ£€æµ‹è¯­è¨€å˜ä½“ï¼šç®€ä½“ä¸­æ–‡(zh)ã€ç¹ä½“ä¸­æ–‡(zh_)ã€è‹±æ–‡(en)
      function detectAnnouncementLanguage() {
        try {
          // ä¼˜å…ˆè¯»å–åº”ç”¨è®¾ç½®
          const savedLang = localStorage.getItem('lyra_exporter_language');
          if (savedLang) {
            if (savedLang === 'zh') {
              // æ£€æµ‹ç®€ç¹ä½“
              const browserLang = (navigator.language || navigator.userLanguage || '').toLowerCase();
              if (browserLang.includes('tw') || browserLang.includes('hk') ||
                  browserLang.includes('mo') || browserLang.includes('hant')) {
                return 'zh_'; // ç¹ä½“
              }
              return 'zh'; // ç®€ä½“
            }
            return 'en'; // å…¶ä»–è¯­è¨€éƒ½æ˜¾ç¤ºè‹±æ–‡
          }

          // æ²¡æœ‰ä¿å­˜è®¾ç½®ï¼Œæ ¹æ®æµè§ˆå™¨è¯­è¨€åˆ¤æ–­
          const browserLang = (navigator.language || navigator.userLanguage || '').toLowerCase();
          if (browserLang.startsWith('zh')) {
            if (browserLang.includes('tw') || browserLang.includes('hk') ||
                browserLang.includes('mo') || browserLang.includes('hant')) {
              return 'zh_'; // ç¹ä½“
            }
            return 'zh'; // ç®€ä½“
          }
          return 'en'; // é»˜è®¤è‹±æ–‡
        } catch (error) {
          return 'en';
        }
      }

      // å¤šè¯­è¨€å…¬å‘Šæ–‡æœ¬
      const announcementTexts = {
        zh: {
          title: 'ç‰ˆæœ¬æ›´æ–° - æ–°åŠŸèƒ½ä¸Šçº¿',
          intro: 'æœ¬æ¬¡æ›´æ–°å¸¦æ¥ä»¥ä¸‹æ–°åŠŸèƒ½ï¼š',
          button: 'æˆ‘çŸ¥é“äº†',
          features: [
            { title: 'æ”¯æŒ Grok å¤šåˆ†æ”¯è§£æ', desc: 'æ›´æ–°é…å¥—è„šæœ¬è‡³æœ€æ–°ç‰ˆæœ¬å³å¯ä½¿ç”¨' },
            { title: 'æ‰¹é‡åŠ è½½ã€å¯¼å‡ºåŠŸèƒ½', desc: 'ç°åœ¨å¯ä»¥ä¸€æ¬¡è¯»å…¥æ•´ä¸ªæ–‡ä»¶å¤¹(çº¯æœ¬åœ°æµè§ˆå™¨é™æ€å·¥ä½œ)ï¼Œä¿®å¤ä¹‹å‰æ‰¹é‡å¯¼å‡ºmarkdownå¤±è´¥çš„é—®é¢˜' },
            { title: 'è¯­ä¹‰æœç´¢åŠŸèƒ½', desc: 'éœ€è¦é…åˆembeddingæ¨¡å‹ä½¿ç”¨' },
            { title: 'SillyTavernå¤šåˆ†æ”¯è§£æå¢å¼º', desc: 'ç°åœ¨å¯ä»¥è¯»å…¥ä¸€æ•´ä¸ªæ–‡ä»¶å¤¹çš„SillyTavernå¯¹è¯ï¼Œåªèƒ½åˆå¹¶ä¸åŒåˆ†æ”¯åˆ°åŒä¸€æ—¶é—´çº¿' },
            { title: 'ç§»åŠ¨ç«¯ä½“éªŒä¼˜åŒ–', desc: 'å‘ä¸‹æ»šåŠ¨éšè—å¯¼èˆªæ ï¼Œæ”¯æŒè¿”å›æ“ä½œï¼Œç§»åŠ¨ç«¯ä¸“é¡¹å…¨å±€æœç´¢ç•Œé¢ï¼Œä»¥åŠå…¶ä»–ç»†èŠ‚' }
          ]
        },
        zh_: {
          title: 'ç‰ˆæœ¬æ›´æ–° - æ–°åŠŸèƒ½ä¸Šç·š',
          intro: 'æœ¬æ¬¡æ›´æ–°å¸¶ä¾†ä»¥ä¸‹æ–°åŠŸèƒ½ï¼š',
          button: 'æˆ‘çŸ¥é“äº†',
          features: [
            { title: 'æ”¯æ´ Grok å¤šåˆ†æ”¯è§£æ', desc: 'é…å¥—è…³æœ¬çš„æœ€æ–°ç‰ˆæœ¬å¯ç”¨' },
            { title: 'æ‰¹æ¬¡åŒ¯å‡ºæœ€æ–°åˆ†æ”¯åŠŸèƒ½', desc: 'ç¾åœ¨æ•´å€‹è³‡æ–™å¤¾å¯ä¸€æ¬¡è¼‰å…¥ï¼ˆç´”ç²¹åœ¨æœ¬åœ°ç€è¦½å™¨é€²è¡Œéœæ…‹è™•ç†ï¼‰ï¼Œè§£æ±ºäº†å…ˆå‰æ‰¹æ¬¡åŒ¯å‡º Markdown æª”æ¡ˆå¤±æ•—çš„å•é¡Œ' },
            { title: 'èªç¾©æœå°‹', desc: 'éœ€è¦èˆ‡åµŒå…¥æ¨¡å‹æ•´åˆ' },
            { title: 'SillyTavernå¤šåˆ†æ”¯è§£æå¼·åŒ–', desc: 'ç¾åœ¨å¯ä»¥åŒ¯å…¥æ•´å€‹ SillyTavern å°è©±è³‡æ–™å¤¾ï¼Œå°‡ä¸åŒåˆ†æ”¯åˆä½µç‚ºå®Œæ•´çš„æ™‚åºè¨˜éŒ„' },
            { title: 'Mobile é«”é©—å„ªåŒ–', desc: 'å‘ä¸‹æ²å‹•ä»¥éš±è—å°è¦½åˆ—ï¼Œæ”¯æ´è¿”å›åŠŸèƒ½ã€å°ˆå±¬è¡Œå‹•è£ç½®å…¨ç«™æœå°‹ä»‹é¢åŠå…¶ä»–ç´°ç¯€' }
          ]
        },
        en: {
          title: 'Version Update - New Features',
          intro: 'This update brings the following new features:',
          button: 'Got it',
          features: [
            { title: 'Grok Multi-branch Parsing', desc: 'Update the supporting scripts to the latest version to use them.' },
            { title: 'Batch import and export', desc: 'Now supports loading entire folders at once (pure local browser static work), fixing the previous issue where batch exporting Markdown files failed.' },
            { title: 'Semantic search', desc: 'Requires integration with embedding models.' },
            { title: 'SillyTavern Multi-Branch Parsing Enhancement', desc: 'It is now possible to import an entire folder of SillyTavern conversations, merging different branches into a completed timeline.' },
            { title: 'Mobile Experience Optimisation', desc: 'Scroll down to hide the navigation bar, supporting the back function, a dedicated mobile global search interface, and other details.' }
          ]
        }
      };

      // æ›´æ–°å…¬å‘Šè¯­è¨€
      function updateAnnouncementLanguage() {
        const lang = detectAnnouncementLanguage();
        const texts = announcementTexts[lang] || announcementTexts.en;

        // æ›´æ–°æ ‡é¢˜
        const titleEl = document.querySelector('#version-announcement h2');
        if (titleEl) {
          titleEl.innerHTML = '<span style="font-size: 24px;">ğŸ‰</span> ' + texts.title;
        }

        // æ›´æ–°ä»‹ç»æ–‡å­—
        const introEl = document.querySelector('#version-announcement p');
        if (introEl) {
          introEl.textContent = texts.intro;
        }

        // æ›´æ–°æŒ‰é’®
        const btnEl = document.querySelector('#version-announcement button');
        if (btnEl) {
          btnEl.textContent = texts.button;
        }

        // æ›´æ–°åŠŸèƒ½åˆ—è¡¨
        const listEl = document.querySelector('#version-announcement ul');
        if (listEl) {
          listEl.innerHTML = texts.features.map(function(f) {
            return '<li style="margin-bottom: 8px;">' +
              '<strong>' + f.title + '</strong><br/>' +
              '<span style="color: #888; font-size: 13px;">' + f.desc + '</span>' +
            '</li>';
          }).join('');
        }
      }

      function closeAnnouncement() {
        const announcement = document.getElementById('version-announcement');
        if (announcement) {
          announcement.style.display = 'none';
          localStorage.setItem(STORAGE_KEY, 'true');
        }
      }

      // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºå…¬å‘Š
      window.addEventListener('load', function() {
        const hasSeenAnnouncement = localStorage.getItem(STORAGE_KEY);
        if (!hasSeenAnnouncement) {
          const announcement = document.getElementById('version-announcement');
          if (announcement) {
            updateAnnouncementLanguage(); // å…ˆæ›´æ–°è¯­è¨€
            // å»¶è¿Ÿ500msæ˜¾ç¤ºï¼Œè®©é¡µé¢å…ˆåŠ è½½
            setTimeout(function() {
              announcement.style.display = 'block';
            }, 500);
          }
        }
      });
    </script>
  </body>
</html>
